require(["jquery","layerWrapper","template","jquery.validate","jquery.ajax.extension"],function(a,b,c){a(function(){function d(){a(".count-num").each(function(b,c){a(this).text(parseInt(a(this).attr("data-num"))*parseInt(h.val()))})}function e(c){var d={};"add"==c?d={url:"/point-shop/add-address",data:{realName:a("#Recipient").val(),mobile:a("#Phone").val(),address:a("#AddRess").val()}}:"update"==c&&(d={url:"/point-shop/update-address",data:{id:a("#updatePlace").attr("data-id"),realName:a("#Recipient").val(),mobile:a("#Phone").val(),address:a("#AddRess").val()}}),a.ajax({url:d.url,type:"POST",dataType:"json",data:d.data}).done(function(a){a.data.status?location.reload():f(a.data)}).fail(function(){b.msg("请求失败，请重试！")})}function f(d){a("#errorTip").html(c("errorTipTpl",d)),b.open({type:1,title:!1,area:["300px","180px"],content:a("#errorTip")})}var g=a(".order-number"),h=g.find(".num-text"),i=g.find(".total-num i"),j=a("#orderBtn"),k=a("#addPlace"),l=a("#updatePlace"),m=a("#addressForm");g.on("click",".low-btn",function(a){a.preventDefault(),i.text()>0&&(h.val()>1?h.val(function(a,b){return parseInt(b)-1})&&d():h.val("1"))}).on("click",".add-btn",function(a){a.preventDefault(),i.text()>0&&(h.val()<parseInt(i.text())?h.val(function(a,b){return parseInt(b)+1})&&d():h.val(i.text()))}),d(),j.on("click",function(c){c.preventDefault();var d=a(this),e=d.attr("data-id"),g=d.attr("data-type");a.ajax({url:"/point-shop/order",type:"POST",dataType:"json",data:{id:e,goodsType:g,number:h.val(),userAddressId:a("#updatePlace").attr("data-id")}}).done(function(a){console.log(a),a.data.status?(b.msg("兑换成功！3秒后自动跳转到兑换记录页面。"),setTimeout(function(){location.href="/point-shop/record"},3e3)):f(a.data)}).fail(function(a){b.msg("请求失败，请重试！")})}),k.on("click",function(c){c.preventDefault(),m.attr("data-type","add"),b.open({type:1,title:"添加地址",area:["700px","auto"],content:a("#fixAdress")})}),l.on("click",function(c){c.preventDefault();var d=a(this),e=d.attr("data-user"),f=d.attr("data-phone"),g=d.attr("data-address");a("#Recipient").val(e),a("#Phone").val(f),a("#AddRess").val(g),m.attr("data-type","update"),b.open({type:1,title:"添加地址",area:["700px","auto"],content:a("#fixAdress")})}),jQuery.validator.addMethod("isPhone",function(a,b){var c=/0?(13|14|15|18)[0-9]{9}/;return this.optional(b)||c.test(a)},"请正确填写您的手机号码"),m.validate({debug:!0,focusInvalid:!1,rules:{Recipient:{required:!0},Phone:{required:!0,isPhone:!0,minlength:11,maxlength:11},AddRess:{required:!0,maxlength:100}},messages:{Recipient:{required:"请填写收件人"},Phone:{required:"请输入手机号",isPhone:"请输入正确的手机号码",minlength:"手机格式不正确",maxlength:"手机格式不正确"},AddRess:{required:"请填写收件地址",maxlength:"收件地址字数限制在100字以内"}},errorPlacement:function(a,b){a.appendTo(b.parent())},submitHandler:function(b){e(a(b).attr("data-type"))}}),a("body").on("click",".close-layer",function(a){a.preventDefault(),b.closeAll()})})});