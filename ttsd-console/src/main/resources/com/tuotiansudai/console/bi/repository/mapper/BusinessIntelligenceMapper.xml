<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tuotiansudai.console.bi.repository.mapper.BusinessIntelligenceMapper">

    <resultMap id="keyValueMap" type="KeyValueModel">
        <result column="name" property="name"></result>
        <result column="value" property="value"></result>
        <result column="group" property="group"></result>
    </resultMap>

    <select id="queryUserRegisterTrend" parameterType="map" resultMap="keyValueMap">
        select
        <if test="granularity.name() == 'Hourly'">
            HOUR (u.register_time) AS `name`,
        </if>
        <if test="granularity.name() == 'Daily'">
            DATE(u.register_time) AS `name`,
        </if>
        <if test="granularity.name() == 'Weekly'">
            DATE_FORMAT(u.register_time, '%Y-W%u') AS `name`,
        </if>
        <if test="granularity.name() == 'Monthly'">
            DATE_FORMAT(u.register_time, '%Y-%m') AS `name`,
        </if>
          count(*) as `value`,
          u.province as `group`
          from
        <if test="roleStage.name() == 'ALL' ">
              user u
        </if>
        <if test="roleStage.name() == 'SD_STAFF' ">
            (SELECT
              j.*
             FROM
              user j
              JOIN
              (SELECT
                  h.login_name
                FROM
                  user_role h
                WHERE h.role = 'SD_STAFF') gg
              ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'ZC_STAFF' ">
            (SELECT
            j.*
            FROM
            user j
            JOIN
            (SELECT
            h.login_name
            FROM
            user_role h
            WHERE h.role = 'ZC_STAFF') gg
            ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'SD_STAFF_RECOMMENDATION' ">
            (SELECT
              j.*
              FROM
                user j
                JOIN
                (SELECT
                  k.`login_name`
                  FROM
                    user_role o
                  RIGHT JOIN referrer_relation k
                    ON o.`login_name` = k.`referrer_login_name`
                    AND k.`level` = 1
                  WHERE o.`role` = 'SD_STAFF') gg
                ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'ZC_STAFF_RECOMMENDATION' ">
            (SELECT
            j.*
            FROM
            user j
            JOIN
            (SELECT
            k.`login_name`
            FROM
            user_role o
            RIGHT JOIN referrer_relation k
            ON o.`login_name` = k.`referrer_login_name`
            AND k.`level` = 1
            WHERE o.`role` = 'ZC_STAFF') gg
            ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'AGENT' ">
            (SELECT
              j.*
            FROM
              user j
              JOIN
              (SELECT
                o.`login_name`
              FROM
                user_role o
              WHERE o.`role` = 'AGENT'
              GROUP BY o.`login_name`) oo
            ON j.`login_name` = oo.login_name) u
        </if>
        <if test="roleStage.name() == 'NOT_STAFF_RECOMMEND' ">
            (SELECT j.* FROM user j WHERE NOT EXISTS
            (SELECT 1 FROM user_role h WHERE h.role = 'NOT_STAFF_RECOMMEND' AND j.login_name = h.login_name)) u
        </if>
        <if test="roleStage.name() == 'OTHERS' ">
            (SELECT
            j.*
            FROM
            user j
            WHERE NOT EXISTS
            (SELECT
            1
            FROM
            (SELECT
            *
            FROM
            (SELECT
            k.`login_name`
            FROM
            user_role o
            RIGHT JOIN referrer_relation k
            ON o.`login_name` = k.`referrer_login_name`
            AND k.`level` = 1
            WHERE o.`role` in ('SD_STAFF', 'ZC_STAFF')
            UNION
            SELECT
            h.login_name
            FROM
            user_role h
            WHERE h.role IN ('SD_STAFF', 'ZC_STAFF', 'AGENT')) ff) gg
            WHERE gg.login_name = j.`login_name`)) u
        </if>

        <choose>
            <when test="province != null and province!= ''">
                where u.province = #{province}
            </when>
            <otherwise>
                where exists (
                    select province from (
                        select province from (
                            select count(*) as v, a.province from user a
                            where a.register_time between #{startTime} and #{endTime}
                            <if test="userStage.name() == 'BindCard'">
                                and exists (select * from bank_card b where  a.login_name = b.login_name and b.status='PASSED' UNION select * from user_bank_card ubc where ubc.login_name=a.login_name and ubc.status='BOUND')
                            </if>
                            <if test="userStage.name() == 'Certification'">
                                and exists (select * from account ac where  a.login_name = ac.login_name  UNION  select * from bank_account ba where ba.login_name=a.login_name)
                            </if>
                            group by province
                        ) t order by v desc limit 5
                    ) p where p.province = u.province
                )
            </otherwise>
        </choose>
        and u.register_time between #{startTime} and #{endTime}
        <if test="channel !=null and channel != '' and channel != '其他' ">
            and u.channel = #{channel}
        </if>
        <if test="channel == '其他'" >
            and u.channel IS NULL
        </if>
        <if test="userStage.name() == 'BindCard'">
          and exists (select * from bank_card b where  u.login_name = b.login_name and b.status='PASSED' UNION select * from user_bank_card ubc where ubc.login_name=u.login_name and ubc.status='BOUND')
        </if>
        <if test="userStage.name() == 'Certification'">
          and exists (select * from account ac where  u.login_name = ac.login_name UNION  select * from bank_account ba where ba.login_name=u.login_name)
        </if>
        group by u.province,
        <if test="granularity.name() == 'Hourly'">
            HOUR (u.register_time)
        </if>
        <if test="granularity.name() == 'Daily'">
          date(u.register_time)
        </if>
        <if test="granularity.name() == 'Weekly'">
          year(u.register_time), week(u.register_time)
        </if>
        <if test="granularity.name() == 'Monthly'">
          year(u.register_time), month(u.register_time)
        </if>
        <if test="province == null or province ==''">
            union all
            select
            <if test="granularity.name() == 'Hourly'">
                HOUR (u.register_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Daily'">
                DATE(u.register_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Weekly'">
                DATE_FORMAT(u.register_time, '%Y-W%u') AS `name`,
            </if>
            <if test="granularity.name() == 'Monthly'">
                DATE_FORMAT(u.register_time, '%Y-%m') AS `name`,
            </if>
              count(*) as `value`,
              '其它' as `group`
            from
            <if test="roleStage.name() == 'ALL' ">
                user u
            </if>
            <if test="roleStage.name() == 'SD_STAFF' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                h.login_name
                FROM
                user_role h
                WHERE h.role = 'SD_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'ZC_STAFF' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                h.login_name
                FROM
                user_role h
                WHERE h.role = 'ZC_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'SD_STAFF_RECOMMENDATION' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                k.`login_name`
                FROM
                user_role o
                RIGHT JOIN referrer_relation k
                ON o.`login_name` = k.`referrer_login_name`
                AND k.`level` = 1
                WHERE o.`role` = 'SD_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'ZC_STAFF_RECOMMENDATION' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                k.`login_name`
                FROM
                user_role o
                RIGHT JOIN referrer_relation k
                ON o.`login_name` = k.`referrer_login_name`
                AND k.`level` = 1
                WHERE o.`role` = 'ZC_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'AGENT' ">
                (SELECT
                  j.*
                FROM
                  user j
                JOIN
                  (SELECT
                    o.`login_name`
                  FROM
                    user_role o
                  WHERE o.`role` = 'AGENT'
                  GROUP BY o.`login_name`) oo
                ON j.`login_name` = oo.login_name) u
            </if>
            <if test="roleStage.name() == 'NOT_STAFF_RECOMMEND' ">
                (SELECT j.* FROM user j WHERE NOT EXISTS
                (SELECT 1 FROM user_role h WHERE h.role = 'NOT_STAFF_RECOMMEND' AND j.login_name = h.login_name)) u
            </if>
            <if test="roleStage.name() == 'OTHERS' ">
                (SELECT
                j.*
                FROM
                user j
                WHERE NOT EXISTS
                (SELECT
                1
                FROM
                (SELECT
                *
                FROM
                (SELECT
                k.`login_name`
                FROM
                user_role o
                RIGHT JOIN referrer_relation k
                ON o.`login_name` = k.`referrer_login_name`
                AND k.`level` = 1
                WHERE o.`role` in ('SD_STAFF', 'ZC_STAFF')
                UNION
                SELECT
                h.login_name
                FROM
                user_role h
                WHERE h.role IN ('SD_STAFF', 'ZC_STAFF', 'AGENT')) ff) gg
                WHERE gg.login_name = j.`login_name`)) u
            </if>
            where not exists (
                select province from (
                    select province from (
                        select count(*) as v, a.province from user a
                        where a.register_time between #{startTime} and #{endTime}
                        <if test="userStage.name() == 'BindCard'">
                            and exists (select * from bank_card b where  a.login_name = b.login_name and b.status='PASSED' UNION select * from user_bank_card ubc where ubc.login_name=a.login_name and ubc.status='BOUND')
                        </if>
                        <if test="userStage.name() == 'Certification'">
                            and exists (select * from account ac where  a.login_name = ac.login_name UNION  select * from bank_account ba where ba.login_name = a.login_name)
                        </if>
                        group by province
                    ) t order by v desc limit 5
                ) p where p.province = u.province
            )
            and u.register_time between #{startTime} and #{endTime}
            <if test="channel !=null and channel != '' and channel != '其他' ">
                and u.channel = #{channel}
            </if>
            <if test="channel == '其他'" >
                and u.channel IS NULL
            </if>
            <if test="userStage.name() == 'BindCard'">
                and exists (select * from bank_card b where  u.login_name = b.login_name and b.status='PASSED' UNION select * from user_bank_card ubc where ubc.login_name=u.login_name and ubc.status='BOUND')
            </if>
            <if test="userStage.name() == 'Certification'">
                and exists (select * from account ac where  u.login_name = ac.login_name union select * from bank_account ba where ba.login_name=u.login_name)
            </if>
            group by
            <if test="granularity.name() == 'Hourly'">
                HOUR (u.register_time)
            </if>
            <if test="granularity.name() == 'Daily'">
                date(u.register_time)
            </if>
            <if test="granularity.name() == 'Weekly'">
                year(u.register_time), week(u.register_time)
            </if>
            <if test="granularity.name() == 'Monthly'">
                year(u.register_time), month(u.register_time)
            </if>
        </if>
    </select>

    <select id="queryUserRechargeTrend" parameterType="map" resultMap="keyValueMap">
        SELECT
        <if test="granularity.name() == 'Hourly'">
            HOUR (re.created_time) AS `name`,
        </if>
        <if test="granularity.name() == 'Daily'">
            DATE(re.`created_time`) AS `name`,
        </if>
        <if test="granularity.name() == 'Weekly'">
            DATE_FORMAT(re.`created_time`, '%Y-W%u') AS `name`,
        </if>
        <if test="granularity.name() == 'Monthly'">
            DATE_FORMAT(re.`created_time`, '%Y-%m') AS `name`,
        </if>
        ROUND(SUM(re.amount / 100), 2) AS `value`,
        us.province AS `group`
        FROM
        `user` us
        <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
            JOIN `bank_recharge` re ON us.login_name = re.login_name AND re.role_type=#{role} AND re.status = 'SUCCESS' AND re.created_time BETWEEN #{startTime} AND #{endTime}
        </if>
        <if test="role != null and role == 'UMP_LOANER'">
            JOIN `recharge` re ON us.login_name = re.login_name AND re.status = 'SUCCESS' AND re.created_time BETWEEN #{startTime} AND #{endTime}
            JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role ON temp_role.login_name = us.login_name
        </if>
        <if test="role != null and role == 'UN_UMP_LOANER' ">
            JOIN `recharge` re ON us.login_name = re.login_name AND re.status = 'SUCCESS' AND re.created_time BETWEEN #{startTime} AND #{endTime}
            JOIN (SELECT
            login_name, GROUP_CONCAT(role) AS role
            FROM
            user_role
            GROUP BY login_name) ur
            ON ur.login_name = us.login_name
            AND ur.role NOT LIKE '%UMP_LOANER%'
        </if>
        WHERE
        us.user_name IS NOT NULL
        <if test="province != null and province !=''">
            AND province = #{province}
        </if>
        <if test="province == null or province == ''">
            --          选择出充值金额最高的五个省份
            AND province IN (SELECT `province` FROM
            (SELECT temp_user_1.province,
            ROUND(SUM(temp_re_1.amount / 100), 2) AS `temp_amount_1`
            FROM `user` AS temp_user_1
            <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
                JOIN `bank_recharge` temp_re_1 ON temp_user_1.login_name = temp_re_1.login_name AND temp_re_1.role_type=#{role} AND temp_re_1.status = 'SUCCESS' AND temp_re_1.created_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="role != null and role == 'UMP_LOANER'">
                JOIN `recharge` temp_re_1 ON temp_user_1.login_name = temp_re_1.login_name AND temp_re_1.status = 'SUCCESS' AND temp_re_1.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role_1 ON temp_role_1.login_name = temp_user_1.login_name
            </if>
            <if test="role != null and role == 'UN_UMP_LOANER' ">
                JOIN `recharge` temp_re_1 ON temp_user_1.login_name = temp_re_1.login_name AND temp_re_1.status = 'SUCCESS' AND temp_re_1.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT
                login_name, GROUP_CONCAT(role) AS role
                FROM
                user_role
                GROUP BY login_name) ur
                ON ur.login_name = temp_user_1.login_name
                AND ur.role NOT LIKE '%UMP_LOANER%'
            </if>
            WHERE temp_user_1.user_name IS NOT NULL
            GROUP BY temp_user_1.province
            ORDER BY `temp_amount_1` DESC LIMIT 5) AS temp_1)
        </if>
        GROUP BY `group`, `name`
        <if test="province == null or province == ''">
            --          将充值金额最高的五个省份之外的省份统一合并成"其他"
            UNION ALL
            SELECT
            <if test="granularity.name() == 'Hourly'">
                HOUR (re.created_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Daily'">
                DATE(re.`created_time`) AS `name`,
            </if>
            <if test="granularity.name() == 'Weekly'">
                DATE_FORMAT(re.`created_time`, '%Y-W%u') AS `name`,
            </if>
            <if test="granularity.name() == 'Monthly'">
                DATE_FORMAT(re.`created_time`, '%Y-%m') AS `name`,
            </if>
            ROUND(SUM(re.amount / 100), 2) AS `value`,
            '其他' AS `group`
            FROM
            `user` us
            <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
                JOIN `bank_recharge` re ON us.login_name = re.login_name AND re.role_type=#{role} AND re.status = 'SUCCESS' AND re.created_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="role != null and role == 'UMP_LOANER'">
                JOIN `recharge` re ON us.login_name = re.login_name AND re.status = 'SUCCESS' AND re.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role ON temp_role.login_name = us.login_name
            </if>
            <if test="role != null and role == 'UN_UMP_LOANER' ">
                JOIN `recharge` re ON us.login_name = re.login_name AND re.status = 'SUCCESS' AND re.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT
                login_name, GROUP_CONCAT(role) AS role
                FROM
                user_role
                GROUP BY login_name) ur
                ON ur.login_name = us.login_name
                AND ur.role NOT LIKE '%UMP_LOANER%'
            </if>
            WHERE
            us.user_name IS NOT NULL
            AND province NOT IN (SELECT `province` FROM
            (SELECT temp_user_2.province,
            ROUND(SUM(temp_re_2.amount / 100), 2) AS `temp_amount_2`
            FROM `user` AS temp_user_2
            <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
                JOIN `bank_recharge` temp_re_2 ON temp_user_2.login_name = temp_re_2.login_name AND temp_re_2.role_type=#{role} AND temp_re_2.status = 'SUCCESS' AND temp_re_2.created_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="role != null and role == 'UMP_LOANER'">
                JOIN `recharge` temp_re_2 ON temp_user_2.login_name = temp_re_2.login_name AND temp_re_2.status = 'SUCCESS' AND temp_re_2.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role_2 ON temp_role_2.login_name = temp_user_2.login_name
            </if>
            <if test="role != null and role == 'UN_UMP_LOANER' ">
                JOIN `recharge` temp_re_2 ON temp_user_2.login_name = temp_re_2.login_name AND temp_re_2.status = 'SUCCESS' AND temp_re_2.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT
                login_name, GROUP_CONCAT(role) AS role
                FROM
                user_role
                GROUP BY login_name) ur
                ON ur.login_name = temp_user_2.login_name
                AND ur.role NOT LIKE '%UMP_LOANER%'
            </if>
            WHERE temp_user_2.user_name IS NOT NULL
            GROUP BY temp_user_2.province
            ORDER BY `temp_amount_2` DESC LIMIT 5) AS temp_2)
            GROUP BY `group`, `name`
        </if>
    </select>

    <select id="queryUserWithdrawTrend" parameterType="map" resultMap="keyValueMap">
        SELECT
        <if test="granularity.name() == 'Hourly'">
            HOUR (w.created_time) AS `name`,
        </if>
        <if test="granularity.name() == 'Daily'">
            DATE(w.`created_time`) AS `name`,
        </if>
        <if test="granularity.name() == 'Weekly'">
            DATE_FORMAT(w.`created_time`, '%Y-W%u') AS `name`,
        </if>
        <if test="granularity.name() == 'Monthly'">
            DATE_FORMAT(w.`created_time`, '%Y-%m') AS `name`,
        </if>
        ROUND(SUM(w.amount / 100), 2) AS `value`,
        us.province AS `group`
        FROM
        `user` us
        <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
            JOIN `bank_withdraw` w ON us.login_name = w.login_name AND w.role_type=#{role} AND w.status = 'SUCCESS' AND w.created_time BETWEEN #{startTime} AND #{endTime}
        </if>
        <if test="role != null and role == 'UMP_LOANER'">
            JOIN `withdraw` w ON us.login_name = w.login_name AND w.status = 'SUCCESS' AND w.created_time BETWEEN #{startTime} AND #{endTime}
            JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role ON temp_role.login_name = us.login_name
        </if>
        <if test="role != null and role == 'UN_UMP_LOANER' ">
            JOIN `withdraw` w ON us.login_name = w.login_name AND w.status = 'SUCCESS' AND w.created_time BETWEEN #{startTime} AND #{endTime}
            JOIN (SELECT
            login_name, GROUP_CONCAT(role) AS role
            FROM
            user_role
            GROUP BY login_name) ur
            ON ur.login_name = us.login_name
            AND ur.role NOT LIKE '%UMP_LOANER%'
        </if>
        WHERE
        us.user_name IS NOT NULL
        <if test="province != null and province !=''">
            AND province = #{province}
        </if>
        <if test="province == null or province == ''">
            --          选择出提现金额最高的五个省份
            AND province IN (SELECT `province` FROM
            (SELECT temp_user_1.province,
            ROUND(SUM(temp_w_1.amount / 100), 2) AS `temp_amount_1`
            FROM `user` AS temp_user_1
            <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
                JOIN `bank_withdraw` temp_w_1 ON temp_user_1.login_name = temp_w_1.login_name AND temp_w_1.role_type=#{role} AND temp_w_1.status = 'SUCCESS' AND temp_w_1.created_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="role != null and role == 'UMP_LOANER'">
                JOIN `withdraw` temp_w_1 ON temp_user_1.login_name = temp_w_1.login_name AND temp_w_1.status = 'SUCCESS' AND temp_w_1.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role_1 ON temp_role_1.login_name = temp_user_1.login_name
            </if>
            <if test="role != null and role == 'UN_UMP_LOANER' ">
                JOIN `withdraw` temp_w_1 ON temp_user_1.login_name = temp_w_1.login_name AND temp_w_1.status = 'SUCCESS' AND temp_w_1.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT
                login_name, GROUP_CONCAT(role) AS role
                FROM
                user_role
                GROUP BY login_name) ur
                ON ur.login_name = temp_user_1.login_name
                AND ur.role NOT LIKE '%UMP_LOANER%'
            </if>
            WHERE temp_user_1.user_name IS NOT NULL
            GROUP BY temp_user_1.province
            ORDER BY `temp_amount_1` DESC LIMIT 5) AS temp_1)
        </if>
        GROUP BY `group`, `name`
        <if test="province == null or province == ''">
            --          将提现金额最高的五个省份之外的省份统一合并成"其他"
            UNION ALL
            SELECT
            <if test="granularity.name() == 'Hourly'">
                HOUR (w.created_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Daily'">
                DATE(w.`created_time`) AS `name`,
            </if>
            <if test="granularity.name() == 'Weekly'">
                DATE_FORMAT(w.`created_time`, '%Y-W%u') AS `name`,
            </if>
            <if test="granularity.name() == 'Monthly'">
                DATE_FORMAT(w.`created_time`, '%Y-%m') AS `name`,
            </if>
            ROUND(SUM(w.amount / 100), 2) AS `value`,
            '其他' AS `group`
            FROM
            `user` us
            <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
                JOIN `bank_withdraw` w ON us.login_name = w.login_name AND w.role_type=#{role} AND w.status = 'SUCCESS' AND w.created_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="role != null and role == 'UMP_LOANER'">
                JOIN `withdraw` w ON us.login_name = w.login_name AND w.status = 'SUCCESS' AND w.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role ON temp_role.login_name = us.login_name
            </if>
            <if test="role != null and role == 'UN_UMP_LOANER' ">
                JOIN `withdraw` w ON us.login_name = w.login_name AND w.status = 'SUCCESS' AND w.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT
                login_name, GROUP_CONCAT(role) AS role
                FROM
                user_role
                GROUP BY login_name) ur
                ON ur.login_name = us.login_name
                AND ur.role NOT LIKE '%UMP_LOANER%'
            </if>
            WHERE
            us.user_name IS NOT NULL
            AND province NOT IN (SELECT `province` FROM
            (SELECT temp_user_2.province,
            ROUND(SUM(temp_w_2.amount / 100), 2) AS `temp_amount_2`
            FROM `user` AS temp_user_2
            <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
                JOIN `bank_withdraw` temp_w_2 ON temp_user_2.login_name = temp_w_2.login_name AND temp_w_2.role_type=#{role}  AND temp_w_2.status = 'SUCCESS' AND temp_w_2.created_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="role != null and role == 'UMP_LOANER'">
                JOIN `withdraw` temp_w_2 ON temp_user_2.login_name = temp_w_2.login_name AND temp_w_2.status = 'SUCCESS' AND temp_w_2.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT login_name FROM user_role WHERE role = #{role}) AS temp_role_2 ON temp_role_2.login_name = temp_user_2.login_name
            </if>
            <if test="role != null and role == 'UN_UMP_LOANER' ">
                JOIN `withdraw` temp_w_2 ON temp_user_2.login_name = temp_w_2.login_name AND temp_w_2.status = 'SUCCESS' AND temp_w_2.created_time BETWEEN #{startTime} AND #{endTime}
                JOIN (SELECT
                login_name, GROUP_CONCAT(role) AS role
                FROM
                user_role
                GROUP BY login_name) ur
                ON ur.login_name = temp_user_2.login_name
                AND ur.role NOT LIKE '%UMP_LOANER%'
            </if>
            WHERE temp_user_2.user_name IS NOT NULL
            GROUP BY temp_user_2.province
            ORDER BY `temp_amount_2` DESC LIMIT 5) AS temp_2)
            GROUP BY `group`, `name`
        </if>
    </select>

    <select id="queryInvestViscosity" parameterType="map" resultMap="keyValueMap">
        select
          a.loan_count as `name`,
          count(*) as `value`,
          '续投用户' as `group`
        from (
          select
            count(distinct i.loan_id) as loan_count
          from invest i
          <if test="province != null and province !=''">
          inner join `user` u
          on i.login_name = u.login_name
          </if>
          where
            i.status='SUCCESS'
            and i.transfer_invest_id is NULL
            and i.loan_id > 1
            and i.created_time between #{startTime} and #{endTime}
            <if test="province != null and province !=''">
            and u.province = #{province}
            </if>
          group by i.login_name
        ) a
        group by a.loan_count;
    </select>

    <select id="queryInvestCountViscosity" parameterType="map" resultMap="keyValueMap">
        select
        a.loan_count as `name`,
        count(*) as `value`,
        '续投用户' as `group`
        from (
        select
        count(distinct id) as loan_count
        from invest i
        <if test="province != null and province !=''">
            inner join `user` u
            on i.login_name = u.login_name
        </if>
        where
        i.status='SUCCESS'
        and i.transfer_invest_id is NULL
        and i.loan_id > 1
        and i.created_time between #{startTime} and #{endTime}
        <if test="province != null and province !=''">
            and u.province = #{province}
        </if>
        group by i.login_name
        ) a
        group by a.loan_count;
    </select>

    <resultMap id="investViscosityDetailView" type="InvestViscosityDetailView">
        <result column="login_name" property="loginName"></result>
        <result column="user_name" property="userName"></result>
        <result column="mobile" property="mobile"></result>
        <result column="is_staff" property="isStaff"></result>
        <result column="referrer" property="referrer"></result>
        <result column="referrer_user_name" property="referrerUserName"></result>
        <result column="is_referrer_staff" property="isReferrerStaff"></result>
        <result column="total_amount" property="totalAmount"></result>
        <result column="last_invest_time" property="lastInvestTime"></result>
        <result column="loan_count" property="loanCount"></result>
    </resultMap>

    <select id="queryInvestViscosityDetail" parameterType="map" resultMap="investViscosityDetailView">
        select
            temp.login_name,
            u.user_name,
            u.mobile,
            IFNULL((select 1 from user_role ur where ur.login_name = temp.login_name and ur.role in ('SD_STAFF', 'ZC_STAFF')),0) as is_staff,
            u.referrer,
            (select referrer.user_name from user referrer where referrer.login_name = u.referrer) as referrer_user_name,
            IFNULL((select 1 from user_role ur where ur.login_name = u.referrer and ur.role in ('SD_STAFF', 'ZC_STAFF')),0) as is_referrer_staff,
            temp.total_amount,
            temp.last_invest_time,
            temp.loan_count
        from (
            select
                i.login_name,
                IFNULL(SUM(i.amount),0) as total_amount,
                MAX(i.created_time) as last_invest_time,
                count(distinct i.loan_id) as loan_count
            from invest i
            <if test="province != null and province !=''">
                inner join `user` uu
                    on i.login_name = uu.login_name
            </if>
            where
                i.status='SUCCESS'
                and i.transfer_invest_id is NULL
                and i.loan_id > 1
                AND i.created_time between #{startTime} and #{endTime}
                <if test="province != null and province !=''">
                    and uu.province = #{province}
                </if>
            group by i.login_name
        ) temp
        LEFT JOIN `user` u on temp.login_name = u.login_name
        WHERE
        <if test="loanCount == 5">
            <![CDATA[ temp.last_invest_time >= #{loanCount} ]]>
        </if>
        <if test="loanCount &lt; 5">
            temp.loan_count = #{loanCount}
        </if>
        ORDER BY temp.total_amount DESC
        LIMIT #{startIndex}, #{pageSize}
    </select>

    <select id="queryInvestCountViscosityDetail" parameterType="map" resultMap="investViscosityDetailView">
        select
        temp.login_name,
        u.user_name,
        u.mobile,
        IFNULL((select 1 from user_role ur where ur.login_name = temp.login_name and ur.role in ('SD_STAFF', 'ZC_STAFF')),0) as is_staff,
        u.referrer,
        (select referrer.user_name from user referrer where referrer.login_name = u.referrer) as referrer_user_name,
        IFNULL((select 1 from user_role ur where ur.login_name = u.referrer and ur.role in ('SD_STAFF', 'ZC_STAFF')),0) as is_referrer_staff,
        temp.total_amount,
        temp.last_invest_time,
        temp.loan_count
        from (
        select
        i.login_name,
        IFNULL(SUM(i.amount),0) as total_amount,
        MAX(i.created_time) as last_invest_time,
        count(distinct i.id) as loan_count
        from invest i
        <if test="province != null and province !=''">
            inner join `user` uu
            on i.login_name = uu.login_name
        </if>
        where
        i.status='SUCCESS'
        and i.transfer_invest_id is NULL
        and i.loan_id > 1
        AND i.created_time between #{startTime} and #{endTime}
        <if test="province != null and province !=''">
            and uu.province = #{province}
        </if>
        group by i.login_name
        ) temp
        LEFT JOIN `user` u on temp.login_name = u.login_name
        WHERE
        <if test="investCount == 5">
            <![CDATA[ temp.loan_count >= #{investCount} ]]>
        </if>
        <if test="investCount &lt; 5">
            temp.loan_count = #{investCount}
        </if>
        ORDER BY temp.total_amount DESC
        LIMIT #{startIndex}, #{pageSize}
    </select>

    <select id="queryInvestViscosityDetailCount" parameterType="map" resultType="int">
        select
            count(temp.login_name)
        from (
            select
                i.login_name,
                count(distinct i.loan_id) as loan_count
            from invest i
                <if test="province != null and province !=''">
                    inner join `user` uu
                    on i.login_name = uu.login_name
                </if>
            where
                i.status='SUCCESS'
                and i.transfer_invest_id is NULL
                and i.loan_id > 1
                AND i.created_time between #{startTime} and #{endTime}
                <if test="province != null and province !=''">
                    and uu.province = #{province}
                </if>
            group by i.login_name
            ) temp
        WHERE
        <if test="loanCount == 5">
            <![CDATA[ temp.loan_count >= #{loanCount} ]]>
        </if>
        <if test="loanCount &lt; 5">
            temp.loan_count = #{loanCount}
        </if>
    </select>

    <select id="queryInvestCountViscosityDetailCount" parameterType="map" resultType="int">
        select
        count(temp.login_name)
        from (
        select
        i.login_name,
        count(distinct i.id) as loan_count
        from invest i
        <if test="province != null and province !=''">
            inner join `user` uu
            on i.login_name = uu.login_name
        </if>
        where
        i.status='SUCCESS'
        and i.transfer_invest_id is NULL
        and i.loan_id > 1
        AND i.created_time between #{startTime} and #{endTime}
        <if test="province != null and province !=''">
            and uu.province = #{province}
        </if>
        group by i.login_name
        ) temp
        WHERE
        <if test="investCount == 5">
            <![CDATA[ temp.loan_count >= #{investCount} ]]>
        </if>
        <if test="investCount &lt; 5">
            temp.loan_count = #{investCount}
        </if>
    </select>

    <select id="queryInvestViscositySumAmount" parameterType="map" resultType="long">
        select
            IFNULL(SUM(temp.total_amount),0) as sum_amount
        from (
            select
                i.login_name,
                IFNULL(SUM(i.amount),0) as total_amount,
                count(distinct i.loan_id) as loan_count
            from invest i
                <if test="province != null and province !=''">
                    inner join `user` uu
                    on i.login_name = uu.login_name
                </if>
            where
                i.status='SUCCESS'
                and i.transfer_invest_id is NULL
                and i.loan_id > 1
                AND i.created_time between #{startTime} and #{endTime}
                <if test="province != null and province !=''">
                    and uu.province = #{province}
                </if>
            group by i.login_name
        ) temp
        WHERE
            <if test="loanCount == 5">
                <![CDATA[ temp.loan_count >= #{loanCount} ]]>
            </if>
            <if test="loanCount &lt; 5">
                temp.loan_count = #{loanCount}
            </if>
    </select>

    <select id="queryInvestCountViscositySumAmount" parameterType="map" resultType="long">
        select
        IFNULL(SUM(temp.total_amount),0) as sum_amount
        from (
        select
        i.login_name,
        IFNULL(SUM(i.amount),0) as total_amount,
        count(distinct i.id) as loan_count
        from invest i
        <if test="province != null and province !=''">
            inner join `user` uu
            on i.login_name = uu.login_name
        </if>
        where
        i.status='SUCCESS'
        and i.transfer_invest_id is NULL
        and i.loan_id > 1
        AND i.created_time between #{startTime} and #{endTime}
        <if test="province != null and province !=''">
            and uu.province = #{province}
        </if>
        group by i.login_name
        ) temp
        WHERE
        <if test="investCount == 5">
            <![CDATA[ temp.loan_count >= #{investCount} ]]>
        </if>
        <if test="investCount &lt; 5">
            temp.loan_count = #{investCount}
        </if>
    </select>

    <select id="queryUserInvestCountTrend" parameterType="map" resultMap="keyValueMap">
        select
            DATE_FORMAT(i.`created_time`,'%H') AS `name`,
            count(1) as `value`,
            u.province as `group`
        from user u
        join invest i
        on u.login_name = i.login_name
        <choose>
            <when test="province != null and province!= ''">
                where u.province = #{province}
            </when>
            <otherwise>
                where exists (
                select 1 from (
                    select uu.province
                    from invest ii
                    join user uu on uu.login_name=ii.login_name
                    where
                      ii.status='SUCCESS'
                      and ii.created_time between #{startTime} and #{endTime}
                      <if test="isTransfer != null">
                          <if test="isTransfer == true">
                              and transfer_invest_id is not NULL
                          </if>
                          <if test="isTransfer != true">
                              and transfer_invest_id is NULL
                          </if>
                      </if>
                    group by uu.province
                    order by count(ii.id)
                    desc limit 5
                ) temp
                where temp.province=u.province
                )
            </otherwise>
        </choose>
        and i.status='SUCCESS'
        and i.created_time between #{startTime} and #{endTime}
        <if test="isTransfer != null">
            <if test="isTransfer == true">
                and transfer_invest_id is not NULL
            </if>
            <if test="isTransfer != true">
                and transfer_invest_id is NULL
            </if>
        </if>
        group by u.province, `name`
        <if test="province == null or province ==''">
            union all
            select
                DATE_FORMAT(i.`created_time`,'%H') AS `name`,
                count(1) as `value`,
                '其它' as `group`
            from user u
            join invest i
            on u.login_name = i.login_name
            where not exists (
                select 1 from (
                    select uu.province
                    from invest ii
                    join user uu on uu.login_name=ii.login_name
                    where
                      ii.status='SUCCESS'
                      and ii.created_time between #{startTime} and #{endTime}
                    group by uu.province
                    order by count(ii.id)
                    desc limit 5
                ) temp
                where temp.province=u.province
            )
            and i.status='SUCCESS'
            and i.created_time between #{startTime} and #{endTime}
            <if test="isTransfer != null">
                <if test="isTransfer == true">
                    and transfer_invest_id is not NULL
                </if>
                <if test="isTransfer != true">
                    and transfer_invest_id is NULL
                </if>
            </if>
            group by `name`
        </if>
    </select>

    <select id="queryUserInvestAmountTrend" parameterType="map" resultMap="keyValueMap">
        select
            <if test="granularity.name() == 'Daily'">
                DATE(i.created_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Weekly'">
                DATE_FORMAT(i.created_time,'%Y-W%u') AS `name`,
            </if>
            <if test="granularity.name() == 'Monthly'">
                DATE_FORMAT(i.created_time,'%Y-%m') AS `name`,
            </if>
            ROUND(IFNULL(SUM(i.amount), 0)/100, 2) as `value`,
            u.province as `group`
        from
        <if test="roleStage.name() == 'ALL' ">
            user u
        </if>
        <if test="roleStage.name() == 'SD_STAFF' ">
            (SELECT
            j.*
            FROM
            user j
            JOIN
            (SELECT
            h.login_name
            FROM
            user_role h
            WHERE h.role = 'SD_STAFF') gg
            ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'ZC_STAFF' ">
            (SELECT
            j.*
            FROM
            user j
            JOIN
            (SELECT
            h.login_name
            FROM
            user_role h
            WHERE h.role = 'ZC_STAFF') gg
            ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'SD_STAFF_RECOMMENDATION' ">
            (SELECT
            j.*
            FROM
            user j
            JOIN
            (SELECT
            k.`login_name`
            FROM
            user_role o
            RIGHT JOIN referrer_relation k
            ON o.`login_name` = k.`referrer_login_name`
            AND k.`level` = 1
            WHERE o.`role` = 'SD_STAFF') gg
            ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'ZC_STAFF_RECOMMENDATION' ">
            (SELECT
            j.*
            FROM
            user j
            JOIN
            (SELECT
            k.`login_name`
            FROM
            user_role o
            RIGHT JOIN referrer_relation k
            ON o.`login_name` = k.`referrer_login_name`
            AND k.`level` = 1
            WHERE o.`role` = 'ZC_STAFF') gg
            ON j.`login_name` = gg.login_name) u
        </if>
        <if test="roleStage.name() == 'AGENT' ">
            (SELECT
            j.*
            FROM
            user j
            JOIN
            (SELECT
            o.`login_name`
            FROM
            user_role o
            WHERE o.`role` = 'AGENT'
            GROUP BY o.`login_name`) oo
            ON j.`login_name` = oo.login_name) u
        </if>
        <if test="roleStage.name() == 'NOT_STAFF_RECOMMEND' ">
            (SELECT j.* FROM user j WHERE NOT EXISTS
            (SELECT 1 FROM user_role h WHERE h.role = 'NOT_STAFF_RECOMMEND' AND j.login_name = h.login_name)) u
        </if>
        join invest i
        on u.login_name = i.login_name
        <choose>
            <when test="province != null and province!= ''">
                where u.province = #{province}
            </when>
            <otherwise>
                where exists (
                    select 1 from (
                        select
                          uu.province as province,
                          IFNULL(SUM(ii.amount), 0) as amount
                        from invest ii
                        join
                        <if test="roleStage.name() == 'ALL' ">
                            user uu
                        </if>
                        <if test="roleStage.name() == 'SD_STAFF' ">
                            (SELECT
                            j.*
                            FROM
                            user j
                            JOIN
                            (SELECT
                            h.login_name
                            FROM
                            user_role h
                            WHERE h.role = 'SD_STAFF') gg
                            ON j.`login_name` = gg.login_name) u
                        </if>
                        <if test="roleStage.name() == 'ZC_STAFF' ">
                            (SELECT
                            j.*
                            FROM
                            user j
                            JOIN
                            (SELECT
                            h.login_name
                            FROM
                            user_role h
                            WHERE h.role = 'ZC_STAFF') gg
                            ON j.`login_name` = gg.login_name) u
                        </if>
                        <if test="roleStage.name() == 'SD_STAFF_RECOMMENDATION' ">
                            (SELECT
                            j.*
                            FROM
                            user j
                            JOIN
                            (SELECT
                            k.`login_name`
                            FROM
                            user_role o
                            RIGHT JOIN referrer_relation k
                            ON o.`login_name` = k.`referrer_login_name`
                            AND k.`level` = 1
                            WHERE o.`role` = 'SD_STAFF') gg
                            ON j.`login_name` = gg.login_name) u
                        </if>
                        <if test="roleStage.name() == 'ZC_STAFF_RECOMMENDATION' ">
                            (SELECT
                            j.*
                            FROM
                            user j
                            JOIN
                            (SELECT
                            k.`login_name`
                            FROM
                            user_role o
                            RIGHT JOIN referrer_relation k
                            ON o.`login_name` = k.`referrer_login_name`
                            AND k.`level` = 1
                            WHERE o.`role` = 'ZC_STAFF') gg
                            ON j.`login_name` = gg.login_name) u
                        </if>
                        <if test="roleStage.name() == 'AGENT' ">
                            (SELECT
                            j.*
                            FROM
                            user j
                            JOIN
                            (SELECT
                            o.`login_name`
                            FROM
                            user_role o
                            WHERE o.`role` = 'AGENT'
                            GROUP BY o.`login_name`) oo
                            ON j.`login_name` = oo.login_name) uu
                        </if>
                        <if test="roleStage.name() == 'NOT_STAFF_RECOMMEND' ">
                            (SELECT j.* FROM user j WHERE NOT EXISTS
                            (SELECT 1 FROM user_role h WHERE h.role = 'NOT_STAFF_RECOMMEND' AND j.login_name = h.login_name)) uu
                        </if>
                          on uu.login_name=ii.login_name
                        where
                          ii.status='SUCCESS'
                          and ii.loan_id > 1
                          and ii.created_time between #{startTime} and #{endTime}
                        group by province
                        order by amount desc
                        limit 5
                    ) temp
                    where temp.province=u.province
                )
            </otherwise>
        </choose>
        and i.status='SUCCESS'
        and i.loan_id > 1
        and i.created_time between #{startTime} and #{endTime}
        <if test="channel !=null and channel != '' and channel != '其他' ">
            and u.channel = #{channel}
        </if>
        <if test="channel == '其他'" >
            and u.channel IS NULL
        </if>
        <if test="isTransfer != null">
            <if test="isTransfer == true">
                and transfer_invest_id is not NULL
            </if>
            <if test="isTransfer != true">
                and transfer_invest_id is NULL
            </if>
        </if>
        group by u.province, `name`
        <if test="province == null or province ==''">
            union all
            select
            <if test="granularity.name() == 'Daily'">
                DATE(i.created_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Weekly'">
                DATE_FORMAT(i.created_time,'%Y-W%u') AS `name`,
            </if>
            <if test="granularity.name() == 'Monthly'">
                DATE_FORMAT(i.created_time,'%Y-%m') AS `name`,
            </if>
            <if test="granularity.name() == 'Hourly'">
                DATE_FORMAT(i.`created_time`,'%H') AS `name`,
            </if>
            ROUND(IFNULL(SUM(i.amount), 0)/100, 2) as `value`,
            '其它' as `group`
            from
            <if test="roleStage.name() == 'ALL' ">
                user u
            </if>
            <if test="roleStage.name() == 'SD_STAFF' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                h.login_name
                FROM
                user_role h
                WHERE h.role = 'SD_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'ZC_STAFF' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                h.login_name
                FROM
                user_role h
                WHERE h.role = 'ZC_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'SD_STAFF_RECOMMENDATION' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                k.`login_name`
                FROM
                user_role o
                RIGHT JOIN referrer_relation k
                ON o.`login_name` = k.`referrer_login_name`
                AND k.`level` = 1
                WHERE o.`role` = 'SD_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'ZC_STAFF_RECOMMENDATION' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                k.`login_name`
                FROM
                user_role o
                RIGHT JOIN referrer_relation k
                ON o.`login_name` = k.`referrer_login_name`
                AND k.`level` = 1
                WHERE o.`role` = 'ZC_STAFF') gg
                ON j.`login_name` = gg.login_name) u
            </if>
            <if test="roleStage.name() == 'AGENT' ">
                (SELECT
                j.*
                FROM
                user j
                JOIN
                (SELECT
                o.`login_name`
                FROM
                user_role o
                WHERE o.`role` = 'AGENT'
                GROUP BY o.`login_name`) oo
                ON j.`login_name` = oo.login_name) u
            </if>
            <if test="roleStage.name() == 'NOT_STAFF_RECOMMEND' ">
                (SELECT j.* FROM user j WHERE NOT EXISTS
                (SELECT 1 FROM user_role h WHERE h.role = 'NOT_STAFF_RECOMMEND' AND j.login_name = h.login_name)) u
            </if>
            join invest i
            on u.login_name = i.login_name
            where not exists (
                select 1 from (
                    select
                        uu.province as province,
                        IFNULL(SUM(ii.amount), 0) as amount
                    from invest ii
                    join
                    <if test="roleStage.name() == 'ALL' ">
                        user uu
                    </if>
                    <if test="roleStage.name() == 'SD_STAFF' ">
                        (SELECT
                        j.*
                        FROM
                        user j
                        JOIN
                        (SELECT
                        h.login_name
                        FROM
                        user_role h
                        WHERE h.role = 'SD_STAFF') gg
                        ON j.`login_name` = gg.login_name) u
                    </if>
                    <if test="roleStage.name() == 'ZC_STAFF' ">
                        (SELECT
                        j.*
                        FROM
                        user j
                        JOIN
                        (SELECT
                        h.login_name
                        FROM
                        user_role h
                        WHERE h.role = 'ZC_STAFF') gg
                        ON j.`login_name` = gg.login_name) u
                    </if>
                    <if test="roleStage.name() == 'SD_STAFF_RECOMMENDATION' ">
                        (SELECT
                        j.*
                        FROM
                        user j
                        JOIN
                        (SELECT
                        k.`login_name`
                        FROM
                        user_role o
                        RIGHT JOIN referrer_relation k
                        ON o.`login_name` = k.`referrer_login_name`
                        AND k.`level` = 1
                        WHERE o.`role` = 'SD_STAFF') gg
                        ON j.`login_name` = gg.login_name) u
                    </if>
                    <if test="roleStage.name() == 'ZC_STAFF_RECOMMENDATION' ">
                        (SELECT
                        j.*
                        FROM
                        user j
                        JOIN
                        (SELECT
                        k.`login_name`
                        FROM
                        user_role o
                        RIGHT JOIN referrer_relation k
                        ON o.`login_name` = k.`referrer_login_name`
                        AND k.`level` = 1
                        WHERE o.`role` = 'ZC_STAFF') gg
                        ON j.`login_name` = gg.login_name) u
                    </if>
                    <if test="roleStage.name() == 'AGENT' ">
                        (SELECT
                        j.*
                        FROM
                        user j
                        JOIN
                        (SELECT
                        o.`login_name`
                        FROM
                        user_role o
                        WHERE o.`role` = 'AGENT'
                        GROUP BY o.`login_name`) oo
                        ON j.`login_name` = oo.login_name) uu
                    </if>
                    <if test="roleStage.name() == 'NOT_STAFF_RECOMMEND' ">
                        (SELECT j.* FROM user j WHERE NOT EXISTS
                        (SELECT 1 FROM user_role h WHERE h.role = 'NOT_STAFF_RECOMMEND' AND j.login_name = h.login_name)) uu
                    </if>
                    on uu.login_name=ii.login_name
                    where
                        ii.status='SUCCESS'
                        and ii.loan_id > 1
                        and ii.created_time between #{startTime} and #{endTime}
                        <if test="isTransfer != null">
                            <if test="isTransfer == true">
                                and transfer_invest_id is not NULL
                            </if>
                            <if test="isTransfer != true">
                                and transfer_invest_id is NULL
                            </if>
                        </if>
                    group by province
                    order by amount desc
                    limit 5
                ) temp
                where temp.province=u.province
            )
            and i.status='SUCCESS'
            and i.loan_id > 1
            and i.created_time between #{startTime} and #{endTime}
            <if test="channel !=null and channel != '' and channel != '其他' ">
                and u.channel = #{channel}
            </if>
            <if test="channel == '其他'" >
                and u.channel IS NULL
            </if>
            <if test="isTransfer != null">
                <if test="isTransfer == true">
                    and transfer_invest_id is not NULL
                </if>
                <if test="isTransfer != true">
                    and transfer_invest_id is NULL
                </if>
            </if>
            group by `name`
        </if>
    </select>

    <select id="queryUserAgeTrend" parameterType="map" resultMap="keyValueMap">
        select
            <![CDATA[if(age<20,'20 岁以下',if(age<35,'20~35 岁',if(age<50,'35~50 岁','50 岁以上')))]]> as `name`,
            count(1) as `value`,
            <choose>
                <when test="province != null and province!= ''"> #{province} </when>
                <otherwise> "全部" </otherwise>
            </choose> as `group`
        from
            (
                select date_format(now(),'%Y')-if(length(u.identity_number)=18,substring(u.identity_number,7,4),1900+substring(u.identity_number,7,2)) as age
                from user u
                where
                    u.identity_number is not null
                    and length(u.identity_number) in (15,18)
                    and u.register_time between #{startTime} and #{endTime}
                    <if test="province != null and province !=''">
                        and u.province=#{province}
                    </if>
                    <if test="isInvestor=='true'">
                    and exists
                        (
                            select 1 from invest i where i.login_name=u.login_name and status = "SUCCESS" and loan_id != 1 and transfer_invest_id is NULL
                        )
                    </if>
            ) temp
        group by `name`;
    </select>

    <select id="queryLoanAmountDistribution" parameterType="map" resultMap="keyValueMap">
        SELECT
          loan.periods AS `name`,
          ROUND(SUM(invest.amount / 100), 2) AS `value`
        FROM
          loan
          JOIN invest
            ON loan.id = invest.loan_id
            AND invest.`status` = 'SUCCESS'
            AND invest.`transfer_invest_id` IS NULL
            AND invest.`invest_time` BETWEEN #{startTime} and #{endTime}
        WHERE loan.`status` IN (
            'RAISING',
            'RECHECK',
            'REPAYING',
            'COMPLETE',
            'OVERDUE'
          )
          AND loan.`product_type` != 'EXPERIENCE'
        GROUP BY loan.periods
        ORDER BY `name` ;
    </select>

    <select id="queryLoanRaisingTimeCostingTrend" parameterType="map" resultMap="keyValueMap">
        select
            periods as `name`,
            GROUP_CONCAT(TIMESTAMPDIFF(HOUR,fundraising_start_time,raising_complete_time) ORDER BY TIMESTAMPDIFF(HOUR,fundraising_start_time,raising_complete_time) ASC) as `value`,
            ROUND(SUM(TIMESTAMPDIFF(HOUR,fundraising_start_time,raising_complete_time))/COUNT(1),0) as `group`
        from
            loan
        where
            fundraising_start_time is not null
            AND raising_complete_time is not null
            AND created_time between #{startTime} and #{endTime}
        group by periods
        order by `name` asc
    </select>

    <select id="queryWithdrawUserCountTrend" parameterType="map" resultMap="keyValueMap">
        select
        <if test="granularity.name() == 'Daily'">
            DATE(created_time) AS `name`,
        </if>
        <if test="granularity.name() == 'Weekly'">
            DATE_FORMAT(created_time, '%Y-W%u') AS `name`,
        </if>
        <if test="granularity.name() == 'Monthly'">
            DATE_FORMAT(created_time, '%Y-%m') AS `name`,
        </if>
        count(distinct(w.login_name)) AS `value`,
        '提现人数' AS `group`
        <if test="role == null or role == 'INVESTOR' or role == 'LOANER'">
            from bank_withdraw w
        </if>
        <if test="role != null and role == 'UMP_LOANER'">
            from withdraw w
            join (select login_name from `user_role` where role = #{role}) temp_role on temp_role.login_name = w.login_name
        </if>
        <if test="role != null and role == 'UN_UMP_LOANER' ">
            from withdraw w
            JOIN (SELECT
            login_name, GROUP_CONCAT(role) AS role
            FROM
            user_role
            GROUP BY login_name) ur
            ON ur.login_name = w.login_name
            AND ur.role NOT LIKE '%UMP_LOANER%'
        </if>
        where status = 'SUCCESS'

        and created_time between #{startTime} and #{endTime}

        group by
        <if test="granularity.name() == 'Daily'">
            date(created_time)
        </if>
        <if test="granularity.name() == 'Weekly'">
            year(created_time), week(created_time)
        </if>
        <if test="granularity.name() == 'Monthly'">
            year(created_time), month(created_time)
        </if>
    </select>

    <select id="queryRepayByRecheckTimeAndActualRepayDate" parameterType="map" resultMap="keyValueMap">
        SELECT
            ROUND(IFNULL(SUM(r.corpus + r.expected_interest + r.default_interest),0)/ 100, 2) AS `value`,
            DATE(DATE_ADD(#{repayDate},INTERVAL -1 DAY)) AS `name`,
            '待收' as `group`
        FROM
            loan l
                LEFT JOIN
            loan_repay r ON l.id = r.loan_id
        WHERE
        l.status IN ('REPAYING' , 'COMPLETE', 'OVERDUE')
            AND l.recheck_time &lt; #{repayDate}
            AND (r.actual_repay_date > #{repayDate} or actual_repay_date is null)
    </select>

    <select id="querySystemBillOutByCreatedTime" parameterType="map" resultMap="keyValueMap">
        SELECT  b.name AS `name` ,sum(b.value) AS `value`,b.group as `group` from(
        (SELECT
            <if test="granularity.name() == 'Daily'">
                DATE(created_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Weekly'">
                DATE_FORMAT(created_time, '%Y-W%u') AS `name`,
            </if>
            <if test="granularity.name() == 'Monthly'">
                DATE_FORMAT(created_time, '%Y-%m') AS `name`,
            </if>
            ROUND(IFNULL(SUM(amount), 0)/ 100, 2) AS `value`,
            '支出' as `group`
        FROM system_bill
        WHERE operation_type = 'OUT'
            <if test="startTime !=null" >
                and created_time >= #{startTime}
            </if>
            <if test="endTime !=null ">
                and created_time &lt;= #{endTime}
            </if>

            GROUP BY
            <if test="granularity.name() == 'Daily'">
                date(created_time)
            </if>
            <if test="granularity.name() == 'Weekly'">
                year(created_time), week(created_time)
            </if>
            <if test="granularity.name() == 'Monthly'">
                year(created_time), month(created_time)
            </if>
            ORDER BY created_time)
        UNION  ALL
        (SELECT
            <if test="granularity.name() == 'Daily'">
                DATE(bb.created_time) AS `name`,
            </if>
            <if test="granularity.name() == 'Weekly'">
                DATE_FORMAT(bb.created_time, '%Y-W%u') AS `name`,
            </if>
            <if test="granularity.name() == 'Monthly'">
                DATE_FORMAT(bb.created_time, '%Y-%m') AS `name`,
            </if>
            ROUND(IFNULL(SUM(bb.amount), 0)/ 100, 2) AS `value`,
            '支出' as `group`
            FROM bank_system_bill bb
            WHERE bb.operation_type = 'OUT'
            <if test="startTime !=null" >
                and bb.created_time >= #{startTime}
            </if>
            <if test="endTime !=null ">
                and bb.created_time &lt;= #{endTime}
            </if>

            GROUP BY
            <if test="granularity.name() == 'Daily'">
                date(bb.created_time)
            </if>
            <if test="granularity.name() == 'Weekly'">
                year(bb.created_time), week(created_time)
            </if>
            <if test="granularity.name() == 'Monthly'">
                year(bb.created_time), month(created_time)
            </if>
            ORDER BY bb.created_time)
        ) AS b  GROUP BY b.`name`,b.`group`
        </select>

    <select id="queryAnxinUserStatus" parameterType="map" resultMap="keyValueMap">
        SELECT count(1) AS `value`,
            CASE skip_auth
            WHEN 1 THEN '已开通且免验'
            WHEN 0 THEN '已开通未免验'
            END  AS `name`
        FROM anxin_sign_property
        <where>
            <if test="startTime !=null" >
              created_time >= #{startTime}
            </if>
            <if test="endTime !=null ">
              AND created_time &lt;= #{endTime}
            </if>
        </where>
        GROUP BY `name`
    </select>

    <select id="queryAnxinInvestSuccess" parameterType="map" resultMap="keyValueMap">
      SELECT COUNT(login_name) AS `value`,
        CASE
          WHEN contract_no = 'OLD' THEN '老用户'
          WHEN contract_no = '' OR contract_no IS NULL THEN '已投资未生成合同'
          ELSE '已投资且生成合同'
        END AS `name`
        FROM invest
        WHERE invest.`status` = 'SUCCESS'
        AND EXISTS (SELECT id FROM loan WHERE invest.loan_id = loan.id AND loan.product_type != 'EXPERIENCE')
        GROUP BY `name`
    </select>

    <select id="queryLoanOutAmountTrend" parameterType="map" resultMap="keyValueMap">
        SELECT
        <if test="granularity.name() == 'Daily'">
            DATE(recheck_time) AS `name`,
        </if>
        <if test="granularity.name() == 'Weekly'">
            DATE_FORMAT(recheck_time, '%Y-W%u') AS `name`,
        </if>
        <if test="granularity.name() == 'Monthly'">
            DATE_FORMAT(recheck_time, '%Y-%m') AS `name`,
        </if>
        ROUND(IFNULL(SUM(loan_amount), 0)/ 100, 2) AS `value`,
        '放款金额' AS `group`
        FROM loan
        WHERE status in ('REPAYING', 'OVERDUE', 'COMPLETE')
        <if test="startTime !=null">
            and recheck_time >= #{startTime}
        </if>
        <if test="endTime !=null ">
            and recheck_time &lt;= #{endTime}
        </if>
        GROUP BY
        <if test="granularity.name() == 'Daily'">
            date(recheck_time)
        </if>
        <if test="granularity.name() == 'Weekly'">
            year(recheck_time), week(recheck_time)
        </if>
        <if test="granularity.name() == 'Monthly'">
            year(recheck_time), month(recheck_time)
        </if>
        ORDER BY recheck_time
    </select>

</mapper>
