require(["jquery","moment","mustache","layerWrapper","text!/tpl/point-bill-table.mustache","pagination","daterangepicker","csrf"],function(a,b,c,d,e,f){a(function(){var f=a(".column-title .title-navli"),g=a("#signBtn"),h=a("#signLayer"),i=a("#closeSign"),j=a("#taskBtn"),k=a("#taskLayer"),l=a("#closeTask"),m=a("#beansDetail"),n=a(".beans-coupon .bean-use");f.on("click",function(b){b.preventDefault();var c=a(this),d=c.index();0==d?location.href="/point":(c.addClass("active").siblings().removeClass("active"),a(".content-list .choi-beans-list:eq("+d+")").show().siblings().hide())}),g.on("click",function(b){b.preventDefault();var c=a(this),d=a(".sign-text"),e=a(".tomorrow-text"),f=a(".add-dou"),g=a("#signBtn");a.ajax({url:c.data("url"),type:"POST",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){b.data.status&&(d.html("签到成功，领取"+b.data.signInPoint+"财豆！"),e.html("明日可领"+b.data.nextSignInPoint+"财豆"),g.addClass("no-click").html("今日已签到"),f.html("+"+b.data.signInPoint),h.fadeIn("fast",function(){a(this).find(".add-dou").animate({bottom:"50px",opacity:"0"},800)}))})}),i.on("click",function(a){a.preventDefault(),location.href="/point"}),j.on("click",function(a){a.preventDefault(),k.fadeIn("fast")}),l.on("click",function(a){a.preventDefault(),k.fadeOut("fast")}),m.on("click",function(b){b.preventDefault(),a(".column-title .title-navli:eq(2)").trigger("click")});var o=b().format("YYYY-MM-DD"),p=b().subtract(1,"week").format("YYYY-MM-DD"),q=b().subtract(1,"month").format("YYYY-MM-DD"),r=b().subtract(6,"month").format("YYYY-MM-DD"),s=a(".date-filter"),t=a(".status-filter"),u=a("#date-picker"),v=a(".pagination");u.dateRangePicker({separator:" ~ "});var w=function(){var b=a(".date-filter .select-item.current").data("day");switch(b){case 1:u.val(o+"~"+o);break;case 7:u.val(p+"~"+o);break;case 30:u.val(q+"~"+o);break;case 180:u.val(r+"~"+o);break;default:u.val("")}},x=function(b){var d=u.val().split("~"),f=a.trim(d[0])||"",g=a.trim(d[1])||"",h=a(".status-filter .select-item.current").data("status"),i={startTime:f,endTime:g,businessType:h,index:b||1};v.loadPagination(i,function(b){b.status&&_.each(b.records,function(a){switch(a.businessType){case"SIGN_IN":a.businessType="签到奖励";break;case"TASK":a.businessType="任务奖励";break;case"INVEST":a.businessType="投资奖励";break;case"EXCHANGE":a.businessType="财豆兑换"}});var d=c.render(e,b);a(".point-bill-list").html(d)})};w(),x(),s.find(".select-item").click(function(){a(this).addClass("current").siblings(".select-item").removeClass("current"),w(),x()}),t.find(".select-item").click(function(){a(this).addClass("current").siblings(".select-item").removeClass("current"),x()}),a(".apply-btn").on("click",function(b){b.preventDefault(),x(),a(".date-filter .select-item").removeClass("current")}),a(".reedom-now").on("click",function(b){b.preventDefault();var c=a(this),e=c.attr("data-id"),f=c.attr("data-beans"),g=c.attr("data-bite");a(this).hasClass("no-click")||d.open({title:"温馨提示",content:"确认兑换"+g+"？",btn:["确定","取消"],yes:function(b,c){d.close(b),a.ajax({url:"/point/"+e+"/exchange",type:"POST",dataType:"json"}).done(function(a){a.status?d.open({title:"温馨提示",content:"兑换成功！您可前去我的宝藏中查看。",btn:["去看看"],yes:function(){location.href="/my-treasure"},end:function(){w(),x(),n.text(Math.round(n.text())-Math.round(f))}}):a.status||"point insufficient"!=a.message?a.status||"coupon exchangeable insufficient"!=a.message?d.alert("兑换失败，请重试！",{title:"温馨提示"}):d.msg("当前优惠券已兑完，请兑换其他优惠券",{icon:5}):d.open({title:"温馨提示",content:"您的财豆不足，赚取足够多的财豆后再来兑换吧！",btn:["赚取财豆","取消"],yes:function(a,b){location.href="/point"}})}).fail(function(){d.alert("兑换失败，请重试！",{title:"温馨提示"})})}})})})});