require(["jquery","moment","mustache","layerWrapper","text!/tpl/point-bill-table.mustache","pagination","daterangepicker","jquery.ajax.extension"],function(a,b,c,d,e,f){a(function(){var f=a(".column-title .title-navli"),g=a("#signBtn"),h=a("#signLayer"),i=a("#closeSign"),j=a("#taskBtn"),k=a("#beansDetail"),l=a(".beans-coupon .bean-use"),m=a("#taskStatusMenu"),n=a(".content-list"),o=a(".task-status",n),p=a(".button-more",n),q=a("#taskFrame").find(".task-box"),r=q.length,s=q.find('a.btn-normal[disabled="disabled"]').length;s==r&&q.hide(),a(".notice-tip").on("click",function(){q.toggle();var b=a(this);q.is(":hidden")?b.find("i").addClass("fa-chevron-down").removeClass("fa-chevron-up"):b.find("i").addClass("fa-chevron-up").removeClass("fa-chevron-down")}),f.on("click",function(b){b.preventDefault();var c=a(this),d=c.index();0==d?location.href="/point":(c.addClass("active").siblings().removeClass("active"),a(".content-list .choi-beans-list:eq("+d+")").show().siblings().hide())}),m.find("span").click(function(b){b.preventDefault();var c=a(this),d=c.index();console.log(d),c.addClass("active").siblings("span").removeClass("active"),a(".task-status").eq(d).show().siblings(".task-status").hide()}),o.find(".border-box").hide(),o.find(".border-box:lt(4)").show(),p.on("click",function(b){b.preventDefault();var c=a(this),d=c.parents(".task-status");c.toggleClass("open"),c.hasClass("open")?(d.find(".border-box").show(),c.find("span").text("收起"),c.find("i").addClass("fa-chevron-circle-up").removeClass("fa-chevron-circle-down")):(d.find(".border-box").hide(),d.find(".border-box:lt(4)").show(),c.find("span").text("点击查看更多任务"),c.find("i").addClass("fa-chevron-circle-down").removeClass("fa-chevron-circle-up"))}),g.on("click",function(b){b.preventDefault();var c=a(this),d=a(".sign-text"),e=a(".tomorrow-text"),f=a(".add-dou"),g=a("#signBtn");a.ajax({url:c.data("url"),type:"POST",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){b.data.status&&(d.html("签到成功，领取"+b.data.signInPoint+"积分！"),e.html("明日可领"+b.data.nextSignInPoint+"积分"),g.addClass("no-click").html("今日已签到"),f.html("+"+b.data.signInPoint),h.fadeIn("fast",function(){a(this).find(".add-dou").animate({bottom:"50px",opacity:"0"},800)}))})}),i.on("click",function(a){a.preventDefault(),location.href="/point"}),j.on("click",function(a){a.preventDefault(),f.eq(1).trigger("click")}),k.on("click",function(b){b.preventDefault(),a(".column-title .title-navli:eq(3)").trigger("click")});var t=b().format("YYYY-MM-DD"),u=b().subtract(1,"week").format("YYYY-MM-DD"),v=b().subtract(1,"month").format("YYYY-MM-DD"),w=b().subtract(6,"month").format("YYYY-MM-DD"),x=a(".date-filter"),y=a(".status-filter"),z=a("#date-picker"),A=a(".pagination");z.dateRangePicker({separator:" ~ "});var B=function(){var b=a(".date-filter .select-item.current").data("day");switch(b){case 1:z.val(t+"~"+t);break;case 7:z.val(u+"~"+t);break;case 30:z.val(v+"~"+t);break;case 180:z.val(w+"~"+t);break;default:z.val("")}},C=function(b){var d=z.val().split("~"),f=a.trim(d[0])||"",g=a.trim(d[1])||"",h=a(".status-filter .select-item.current").data("status"),i={startTime:f,endTime:g,businessType:h,index:b||1};A.loadPagination(i,function(b){b.status&&_.each(b.records,function(a){switch(a.businessType){case"SIGN_IN":a.businessType="签到奖励";break;case"TASK":a.businessType="任务奖励";break;case"INVEST":a.businessType="投资奖励";break;case"EXCHANGE":a.businessType="积分兑换";break;case"LOTTERY":a.businessType="抽奖"}});var d=c.render(e,b);a(".point-bill-list").html(d)})};B(),C(),x.find(".select-item").click(function(){a(this).addClass("current").siblings(".select-item").removeClass("current"),B(),C()}),y.find(".select-item").click(function(){a(this).addClass("current").siblings(".select-item").removeClass("current"),C()}),a(".apply-btn").on("click",function(b){b.preventDefault(),C(),a(".date-filter .select-item").removeClass("current")}),a(".reedom-now").on("click",function(b){b.preventDefault();var c=a(this),e=c.attr("data-id"),f=c.attr("data-beans"),g=c.attr("data-bite");a(this).hasClass("no-click")||d.open({title:"温馨提示",content:"确认兑换"+g+"？",btn:["确定","取消"],yes:function(b,c){d.close(b),a.ajax({url:"/point/"+e+"/exchange",type:"POST",dataType:"json"}).done(function(a){a.status?d.open({title:"温馨提示",content:"兑换成功！您可前去我的宝藏中查看。",btn:["去看看"],yes:function(){location.href="/my-treasure"},end:function(){B(),C(),l.text(Math.round(l.text())-Math.round(f))}}):a.status||"point insufficient"!=a.message?a.status||"coupon exchangeable insufficient"!=a.message?d.alert("兑换失败，请重试！",{title:"温馨提示"}):d.msg("当前优惠券已兑完，请兑换其他优惠券",{icon:5}):d.open({title:"温馨提示",content:"您的积分不足，赚取足够多的积分后再来兑换吧！",btn:["赚取积分","取消"],yes:function(a,b){location.href="/point"}})}).fail(function(){d.alert("兑换失败，请重试！",{title:"温馨提示"})})}})})})});