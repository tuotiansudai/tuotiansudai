require(["underscore","jquery","jquery.validate"],function(a,b){var c=b("#register-user-form"),d=b("#register-account-form");b(".register .fetch-captcha").click(function(){var a=c.validate(),d=a.check(".register .mobile");if(d){var e=b(".register .mobile").val();b.ajax({url:"/register/mobile/"+e+"/sendregistercaptcha",type:"get",dataType:"json",contentType:"application/json; charset=UTF-8",success:function(a){console.log(a)}})}else a.showErrors()}),b.validator.addMethod("regex",function(a,b,c){var d=new RegExp(c);return this.optional(b)||d.test(a)},"请检查您的输入");var e=function(a,c,d){var e=!1,f=d.validator,g=d.element,h=f.previousValue(g),i=d.errorMessage;b.ajax({url:a,type:"GET",dataType:"json",error:function(a){console.log(a),h.valid=e,f.stopRequest(g,e)},success:function(a){if(e=c(a)){var d=f.formSubmitted;f.prepareElement(g),f.formSubmitted=d,f.successList.push(g),delete f.invalid[g.name],f.showErrors()}else{var j={};j[g.name]=h.message=b.isFunction(i)?i(value):i,f.invalid[g.name]=!0,f.showErrors(j)}h.valid=e,f.stopRequest(g,e)}})},f=function(a,c,d){var f=this.previousValue(c),g=this;if(f.old===a)return f.valid;f.old=a,this.startRequest(c);var h=g.defaultMessage(c,"isExist"),i=function(a){return a.success&&!a.data.status},j=b.validator.format(d);return e(j(a),i,{validator:g,element:c,errorMessage:h}),"pending"},g=function(a,c,d){var f=this.previousValue(c),g=this;if(""===b(".register .referrer").val())return g.showErrors(),"pending";if(f.old===a)return f.valid;f.old=a,this.startRequest(c);var h=g.defaultMessage(c,"isNotExist"),i=function(a){return a.success&&a.data.status},j=b.validator.format(d);return e(j(a),i,{validator:g,element:c,errorMessage:h}),"pending"},h=function(a,c,d){var f=this.previousValue(c),g=this,h=g.check(".register .mobile");if(!h)return!1;if(f.old===a)return f.valid;f.old=a,this.startRequest(c);var i=g.defaultMessage(c,"captchaVerify"),j=function(a){return a.success&&a.data.status},k=b.validator.format(d);return e(k(a),j,{validator:g,element:c,errorMessage:i}),"pending"};b.validator.addMethod("isExist",function(a,b,c){return f.call(this,a,b,c)},b.validator.format("该记录已存在")),b.validator.addMethod("isNotExist",function(a,b,c){return g.call(this,a,b,c)},b.validator.format("该记录已存在")),b.validator.addMethod("captchaVerify",function(a,b,c){return h.call(this,a,b,c)},b.validator.format("手机验证码不正确"));var i=function(a){b.ajax({type:"post",url:"/register/user",data:JSON.stringify(a),dataType:"json",contentType:"application/json; charset=UTF-8",success:function(a){var c=b("#register-account-form"),d=b("#register-user-form");if(a.data.status)c.find(".login-name").val(d.find(".login-name").val()),c.find(".mobile").val(d.find(".mobile").val()),b(".register .register-step-one-title").removeClass("active"),b(".register .register-step-one").removeClass("active"),b(".register .register-step-two-title").addClass("active"),b(".register .register-step-two").addClass("active");else{var e=d.validate();e.resetForm(),e.checkForm()}},error:function(a){}})},j=function(a){b.ajax({type:"post",url:"/register/account",data:JSON.stringify(a),dataType:"json",contentType:"application/json; charset=UTF-8",success:function(a){if(a.data.status);else{var b=d.validate();b.resetForm(),b.checkForm()}},error:function(a){}})};d.validate({success:"valid",focusCleanup:!0,focusInvalid:!1,onkeyup:!1,onfocusout:function(a){this.element(a)},submitHandler:function(b){var c=["loginName","mobile","userName","identityNumber"],d=b.elements,e={};return a.each(d,function(a){-1!==c.indexOf(a.name)&&(e[a.name]=a.value)}),j(e),!1},rules:{userName:{required:!0},identityNumber:{required:!0,regex:"^[1-9]\\d{13,16}[a-zA-Z0-9]{1}$"}},messages:{userName:{required:"请输入姓名"},identityNumber:{required:"请输入身份证",regex:"身份证格式不正确"}}}),c.validate({success:"valid",focusCleanup:!0,focusInvalid:!1,onkeyup:!1,submitHandler:function(b){var c=["loginName","mobile","captcha","password","referrer","agreement"],d=b.elements,e={};return a.each(d,function(a){-1!==c.indexOf(a.name)&&("agreement"===a.name?e[a.name]=a.checked:e[a.name]=a.value)}),i(e),!1},onfocusout:function(a){"mobile"===a.name&&b(".register .captcha").val(""),this.element(a)},rules:{loginName:{required:!0,regex:"^[a-zA-Z0-9]+$",rangelength:[5,25],isExist:"/register/loginName/{0}/isexist"},mobile:{required:!0,digits:!0,rangelength:[11,11],isExist:"/register/mobile/{0}/isexist"},password:{required:!0,minlength:6},captcha:{required:!0,digits:!0,rangelength:[6,6],captchaVerify:{param:function(){var a=b(".register .mobile").val();return"/register/mobile/"+a+"/captcha/{0}/verify"}}},referrer:{isNotExist:"/register/loginName/{0}/isExist"}},messages:{loginName:{required:"请输入用户名",regex:"5至25位以字母、数字组合，请勿使用手机号",rangelength:"5至25位以字母、数字组合，请勿使用手机号",isExist:"用户名已存在"},mobile:{required:"请输入手机号",digits:"手机号格式不正确",rangelength:"手机号格式不正确",isExist:"手机号已存在"},password:{required:"请输入密码",minlength:"密码至少6位"},captcha:{required:"请输入手机验证码",digits:"手机验证码格式不正确",rangelength:"手机验证码格式不正确",captchaVerify:"手机验证码不正确"},referrer:{isNotExist:"推荐人不存在"}}})});