require(["underscore","jquery","layerWrapper","placeholder","jquery.validate","jquery.validate.extension","jquery.form","jquery.ajax.extension","commonFun"],function(a,b,c){function d(a){x=p.hasClass("valid"),y=s.hasClass("valid"),z=t.hasClass("valid"),q.is(":hidden")&&(B=!0),B&&x&&y&&z&&A&&C?v.prop("disabled",!1):v.prop("disabled",!0)}var e,f=b(".register-user-form"),g=b(".fetch-captcha",f),h=b(".show-agreement",f),i=b("#agreementInput"),j=b(".image-captcha-dialog"),k=b(".image-captcha-form",j),l=b(".image-captcha",j),m=b(".image-captcha-text",j),n=b(".image-captcha-confirm",j),o=b(".referrer-open",f),p=b("input.login-name",f),q=b("input.referrer",f),r=b("input.captcha",f),s=b("input.mobile",f),t=b("input.password",f),u=b("label.check-label",f),v=b('input[type="submit"]',f),w=b("#referrerError"),x=!1,y=!1,z=!1,A=!1,B=!0,C=!0;b('input[type="text"],input[type="password"]',f).placeholder(),u.on("click",function(a){if("A"!=a.target.tagName.toUpperCase()){var c=b(this),e=c.parents(".agree-last"),f=e.find("i");c.hasClass("checked")?(c.removeClass("checked"),i.prop("checked",!1),f[0].className="sprite-register-no-checked",C=!1):(c.addClass("checked"),i.prop("checked",!0),f[0].className="sprite-register-yes-checked",C=!0),d()}}),o.on("click",function(){var a=b(this),c=!1,e=a.find("i");a.next("li").toggleClass("hide"),c=a.next("li").hasClass("hide"),e[0].className=c?"sprite-register-arrow-bottom":"sprite-register-arrow-right",q.is(":hidden")?B=!0:!q.is(":hidden")&&q.hasClass("error")&&(B=!1),d()}),h.click(function(){c.open({type:1,title:"拓天速贷服务协议",area:["950px","600px"],shadeClose:!0,move:!1,scrollbar:!0,skin:"register-skin",content:b("#agreementBox"),success:function(a,b){}})}),g.on("click",function(){return c.open({type:1,title:"手机验证",area:["300px","190px"],shadeClose:!0,content:b(".image-captcha-dialog"),success:function(a,c){b(".image-captcha-form label").remove(),m.val(""),D()}}),!1});var D=function(){l.attr("src","/register/user/image-captcha?"+(new Date).getTime().toString())};l.click(function(){D()}),k.validate({focusInvalid:!1,onfocusout:function(a){this.checkable(a)||this.optional(a)||this.element(a)},submitHandler:function(a){var d=this;b(a).ajaxSubmit({data:{mobile:b(".mobile").val()},dataType:"json",beforeSubmit:function(a,b,c){n.addClass("loading")},success:function(a){var b=a.data;if(b.status&&!b.isRestricted){c.closeAll();var f=60;return void(e=setInterval(function(){g.html(f+"秒后重新发送").addClass("disabledButton").prop("disabled",!0),0==f&&(clearInterval(e),g.html("重新发送").removeClass("disabledButton").prop("disabled",!1)),f--},1e3))}!b.status&&b.isRestricted&&d.showErrors({imageCaptcha:"短信发送频繁，请稍后再试"}),b.status||b.isRestricted||d.showErrors({imageCaptcha:"图形验证码不正确"}),d.invalid.imageCaptcha=!0,D()},error:function(){d.invalid.imageCaptcha=!0,d.showErrors({imageCaptcha:"图形验证码不正确"}),D()},complete:function(){n.removeClass("loading")}})},rules:{imageCaptcha:{required:!0,regex:/^[a-zA-Z0-9]{5}$/}},messages:{imageCaptcha:{required:"请输入图形验证码",regex:"图形验证码位数不对"}}}),f.validate({ignore:".referrer,.agreement",rules:{loginName:{required:!0,regex:/(?!^\d+$)^\w{5,25}$/,checkLoginName:!0},mobile:{required:!0,digits:!0,minlength:11,maxlength:11,isExist:"/register/user/mobile/{0}/is-exist"},password:{required:!0,regex:/^(?=.*[^\d])(.{6,20})$/},captcha:{required:!0,digits:!0,maxlength:6,minlength:6,checkCaptcha:!0}},messages:{loginName:{required:"请输入用户名",regex:"5位至25位数字与字母下划线组合，不能全部数字"},mobile:{required:"请输入手机号",digits:"必须是数字",minlength:"手机格式不正确",maxlength:"手机格式不正确",isExist:"手机号已存在"},password:{required:"请输入密码",regex:"6位至20位，不能全是数字"},captcha:{required:"请输入验证码",digits:"验证码格式不正确",maxlength:"验证码格式不正确",minlength:"验证码格式不正确",checkCaptcha:"验证码不正确"}},success:function(a,b){d(),g.hasClass("disabledButton")||("mobile"===b.name&&p.hasClass("valid")&&(g.prop("disabled",!1),s.attr("preValue",s.val())),"loginName"===b.name&&s.hasClass("valid")&&g.prop("disabled",!1))},submitHandler:function(a){return q.hasClass("error")?(o.trigger("click"),w.html("推荐人不存在").show(),!1):void a.submit()}}),r.on("keyup",function(a){/^\d{6}$/.test(a.target.value)||(A=!1,b(a.target).addClass("error").removeClass("valid"),v.prop("disabled",!0))}),p.on("keyup",function(a){/(?!^\d+$)^\w{5,25}$/.test(a.target.value)||(x=!1,b(a.target).addClass("error").removeClass("valid"),b(a.target).next().html("请输入用户名"),v.prop("disabled",!0))}),t.on("keyup",function(a){/^(?=.*[^\d])(.{6,20})$/.test(a.target.value)||(z=!1,b(a.target).addClass("error").removeClass("valid"),b(a.target).next().html("请输入密码"),v.prop("disabled",!0))}),s.on("keyup",function(c){e?(clearInterval(e),b("input.captcha",f).removeClass("valid").val("").next("label").html("请输入验证码"),g.html("重新发送").removeClass("disabledButton").prop("disabled",!1)):b("input.captcha",f).removeClass("valid").val(""),a.isEmpty(c.target.value)?(b(c.target).addClass("error").removeClass("valid"),b(c.target).next().html("请输入手机号"),g.prop("disabled",!0)):c.target.value.length<11&&g.prop("disabled",!0),v.prop("disabled",!0),A=!1}),jQuery.validator.addMethod("checkLoginName",function(a,c){var d=b.Deferred();return/(?!^\d+$)^\w{5,25}$/.test(a)?b.ajax({url:"/register/user/login-name/"+a+"/is-exist",async:!1,dataType:"json",success:function(a){var b=a.data.status;b?(d.reject(),x=!1):(d.resolve(),x=!0)}}):(d.reject(),x=!1),"resolved"==d.state()},"用户名已存在"),jQuery.validator.addMethod("checkCaptcha",function(a,c){var e=b("input.mobile",f).val(),g=b.Deferred();return/^\d{6}$/.test(a)&&e?b.ajax({url:"/register/user/mobile/"+e+"/captcha/"+a+"/verify",async:!1,dataType:"json",success:function(a){var b=a.data.status;b?(g.resolve(),A=!0):(g.reject(),A=!1)}}):(g.reject(),A=!1),d(),"resolved"==g.state()},"验证码不正确"),q.on("keyup",function(a){var c=b(a.target),e=a.target.value,f=b.Deferred();e?(b.ajax({url:"/register/user/referrer/"+e+"/is-exist",type:"GET",dataType:"json",async:!1,contentType:"application/json; charset=UTF-8"}).done(function(a){var b=a.data.status;b?(B=!0,f.resolve()):(B=!1,f.reject())}),"resolved"==f.state()?(c.removeClass("error").addClass("valid"),w.html("").hide().show()):(c.removeClass("valid").addClass("error"),w.html("推荐人不存在").show())):(c.removeClass("error").addClass("valid"),w.html("").hide(),B=!0),d()})});