require(["jquery","pagination","mustache","text!/tpl/loan-invest-list.mustache","layerWrapper","underscore","csrf","autoNumeric"],function(a,b,c,d,e,f){var g=a(".loan-detail-content"),h=a(".hid-loan").val(),i=a(".text-input-amount",g),j=a(".account-info",g),k=a(".btn-pay",j),l=a(".loan-nav li"),m=a(".loan-list",g),n=a(".pagination",g),o=a(".errorTip");e.ready(function(){e.photos({photos:"#picListBox"})});var p=g.data("loan-progress");50>=p?(a(".chart-box .rount").css("webkitTransform","rotate("+3.6*p+"deg)"),a(".chart-box .rount2").hide()):(a(".chart-box .rount").css("webkitTransform","rotate(180deg)"),a(".chart-box .rount2").show(),a(".chart-box .rount2").css("webkitTransform","rotate("+3.6*(p-50)+"deg)"));var q=function(){n.loadPagination({index:1},function(b){if(b.status){var e=c.render(d,b);a(".loan-list-con table").html(e)}})};if(m.find(".loan-list-con").eq(0).show(),l.click(function(){var b=a(this);b.addClass("active").siblings("li").removeClass("active");var c=b.index();1===c&&q(),m.find(".loan-list-con").eq(c).show().siblings(".loan-list-con").hide()}),"PREHEAT"===g.data("loan-status")){var r=g.data("loan-countdown");window.setInterval(function(){var b=0,c=0,d=0,e=0;1800>=r&&(r>0?(d=Math.floor(r/60)-24*b*60-60*c,e=Math.floor(r)-24*b*60*60-60*c*60-60*d):(k.prop("disabled",!1),k.html("马上投资"),j.find(".time-item").remove(),j.find(".invest-amount").show(),j.find(".experience-ticket").show(),j.find(".expected-interest-dd").show()),9>=d&&(d="0"+d),9>=e&&(e="0"+e),a("#minute_show").html(d+"分"),a("#second_show").html(e+"秒"),r--)},1e3)}if(i.length){i.autoNumeric("init"),i.focus(function(){e.closeAll("tips")});var s="INVESTOR"===g.data("user-role"),t=a(".ticket-list"),u=a("#use-experience-ticket"),v=a(".experience-income"),w=function(){var a=0;return isNaN(i.autoNumeric("get"))||(a=parseInt((100*i.autoNumeric("get")).toFixed(0))),a},x=function(){var b=w();t.find("li").each(function(c){var d=a(this),e=d.find("input[type='radio']");d.removeClass("disabled"),e.prop("disabled",!1);var f=a(d.find(".ticket-term")),g=f.data("invest-lower-limit")||0,h=f.data("invest-upper-limit")||0;(g>0&&g>b||h>0&&b>h)&&(d.addClass("disabled"),e.prop("disabled",!0))});var c=t.find("li.not-use-coupon"),d=f.sortBy(t.find("li[data-coupon-shared='true']"),function(b){var c=a(b);return new Date(c.data("coupon-created-time")).getTime()*(c.hasClass("disabled")?2:1)}),e=f.sortBy(t.find("li[data-coupon-shared='false'][data-coupon-type='RED_ENVELOPE']"),function(b){var c=a(b);return new Date(c.data("coupon-created-time")).getTime()*(c.hasClass("disabled")?2:1)}),g=f.sortBy(t.find("li[data-coupon-shared='false'][data-coupon-type!='RED_ENVELOPE']"),function(b){var c=a(b);return new Date(c.data("coupon-created-time")).getTime()*(c.hasClass("disabled")?2:1)});d.length>0&&c.css("border-top","solid 1px #fdd8bd"),t.empty().append(d).append(c).append(e).append(g),t.find("li").click(function(b){var c=a(b.currentTarget);if(c.hasClass("disabled")||c.data("coupon-shared"))return!1;c.hasClass("not-use-coupon")?t.find('li input[type="radio"]').prop("checked",!1):a('li.not-use-coupon input[type="radio"]').prop("checked",!1);var d=a.trim(c.find(".ticket-title").text());u.find("span").text(d),c.find("input").prop("checked",!0),v.text(""),"RED_ENVELOPE"!=c.data("coupon-type")&&c.data("coupon-id")&&a.ajax({url:"/calculate-expected-coupon-interest/loan/"+h+"/coupon/"+c.data("coupon-id")+"/amount/"+w(),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(a){v.text("+"+a),k.prop("disabled",!1)}),t.addClass("hide")})},y=function(){var b=w(),c=parseInt(a("form .amountNeedRaised-i").data("amount-need-raised"))||0;return b>0&&c>=b},z=function(){a.ajax({url:"/calculate-expected-interest/loan/"+h+"/amount/"+w(),type:"get",dataType:"json",contentType:"application/json; charset=UTF-8"}).done(function(b){a(".principal-income").text(b)})};s&&z(),i.blur(function(){z()}),i.keyup(function(b){v.text(""),s&&!a("li.not-use-coupon").find("input").prop("checked")&&(t.find('input[type="radio"]').prop("checked",!1),u.find("span").text("请点击选择优惠券"))}),a("form").submit(function(){var b=a(this);if("/invest"===b.attr("action")){if(!s)return location.href="/login?redirect="+encodeURIComponent(location.href),!1;var c=w();if(!y()){var d=0===c?"投资金额不能为0元！":"投资金额不能大于可投金额！";return e.tips('<i class="fa fa-times-circle"></i>'+d,".text-input-amount",{tips:[1,"#ff7200"],time:0}),!1}var f=parseInt(a("form .account-amount").data("user-balance"))||0;if(c>f)return location.href="/recharge",!1}return i.val(i.autoNumeric("get")),!0}),u.click(function(b){var c=a(this);return c.hasClass("disabled")?!1:(t.toggleClass("hide"),c.find(".fa-sort-down").toggleClass("hide").siblings(".fa-sort-up").toggleClass("hide"),t.hasClass("hide")||x(),void(b.stopPropagation?b.stopPropagation():window.event&&(window.event.cancelBubsuble=!0)))}),a("body").click(function(b){var c=b||window.event,d=c.srcElement||c.target;t.hasClass("hide")||0!=a(d).parents(".ticket-list").length||t.addClass("hide")})}o.length&&e.tips('<i class="fa fa-times-circle"></i>'+o.text(),".text-input-amount",{tips:[1,"#ff7200"],time:0})});