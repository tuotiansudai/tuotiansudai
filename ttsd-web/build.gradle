apply plugin: 'war'
apply plugin: 'org.flywaydb.flyway'
apply from: 'db_migration.gradle'

dependencies {
    def springVersion = '4.1.7.RELEASE'
    def freemarkerVersion = '2.3.23'
    def jacksonVersion = '2.5.4'
    compile "org.springframework:spring-webmvc:$springVersion",
            "org.springframework:spring-context-support:$springVersion",
            "org.freemarker:freemarker:$freemarkerVersion",
            "com.fasterxml.jackson.core:jackson-core:$jacksonVersion",
            "com.fasterxml.jackson.core:jackson-databind:$jacksonVersion",
            "com.fasterxml.jackson.core:jackson-annotations:$jacksonVersion",
            'commons-io:commons-io:2.4'

    compile project(':ttsd-service')
}

buildscript {
    repositories {
        jcenter()
    }

    dependencies {
        classpath 'org.flywaydb:flyway-gradle-plugin:3.2.1'
    }
}

war {
    archiveName "ttsd-web.war"
    destinationDir = file("war")
    from('/workspace/new_version_config/ttsd-web/') {
        into 'WEB-INF/classes/'
    }
}

flyway {
    def productionFlywayConfig = '/workspace/new_version_config/ttsd-web/jdbc.properties'
    locations = ['filesystem:db_migration/aa']
    user = 'root'
    password = ''
    outOfOrder = true
    placeholders = ['aa': 'aa']
    schemas = ['aa']
    url = 'jdbc:mysql://192.168.33.10:3306/'
    if (new File(productionFlywayConfig).exists()) {
        Properties properties = new Properties()
        properties.load(new FileInputStream(productionFlywayConfig))
        def schema = properties.getProperty('jdbc.scheam', 'aa')
        user = properties.getProperty('jdbc.username', user)
        password = properties.getProperty('jdbc.password', password)
        url = properties.getProperty('flyway.url', url)
        locations = ["filesystem:db_migration/$schema"]
        placeholders = ['aa': "$schema"]
        schemas = ["$schema"]
    }
}